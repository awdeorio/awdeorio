#!/bin/bash

# Configuration
HOST=localhost
PORT=8000

# Stop on errors
set -Eeuo pipefail

# Start server
SERVERCMD="python3 -m http.server --bind ${HOST} ${PORT}"
echo $SERVERCMD
$SERVERCMD & PID=$!

# Register handler to kill server on exit
function cleanup() {
  kill ${PID} || echo "Error killing process ${PID}"
}
trap cleanup SIGINT SIGQUIT SIGABRT SIGKILL SIGTERM ERR

# Wait for server to start with a timeout
for i in  `seq 10` ; do
  if nc -z ${HOST} ${PORT} &> /dev/null; then
    break
  fi
  sleep 0.2
done
if ! kill -0 ${PID} &> /dev/null; then
  echo "Error: server process is not running"
  cleanup
fi
if ! nc -z ${HOST} ${PORT} &> /dev/null; then
  echo "Error: ${HOST}:${PORT} is not open"
  cleanup
fi

# Open browser tab
open "http://${HOST}:${PORT}"

# Wait for all processes to exit
wait
